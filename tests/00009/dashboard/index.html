<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test #00009 - Visual Verification Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { background-color: #111827; color: #e0e0e0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .data-packet {
            position: absolute;
            background-color: #374151;
            border: 1px solid #6b7280;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre;
            transition: all 1.5s ease-in-out;
            opacity: 0;
            transform: scale(0.5);
            z-index: 10;
        }
        .vis-label {
            font-family: 'Inter', sans-serif;
            color: #e0e0e0;
            font-size: 16px;
            font-weight: bold;
        }
        .narrator-panel {
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            transition: opacity 0.5s ease-in-out;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-8">
    <header class="text-center mb-4">
        <h1 class="text-4xl font-bold text-blue-400">Agent-to-Agent Verification Live Demo</h1>
    </header>

    <div id="network-container" class="relative w-full h-[60vh]">
        <!-- Vis.js will render here -->
    </div>

    <div id="narrator-panel" class="narrator-panel p-4 rounded-lg text-center mt-4 border border-gray-700">
        <p id="narrator-text" class="text-xl text-gray-300">Initializing Live Demo...</p>
    </div>

     <div id="result-panel" class="text-center mt-8 transition-opacity duration-500 opacity-0">
        <h2 id="result-text" class="text-4xl font-bold">&nbsp;</h2>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultText = document.getElementById('result-text');
            const resultPanel = document.getElementById('result-panel');
            const narratorText = document.getElementById('narrator-text');
            const container = document.getElementById('network-container');

            const colors = {
                alice: '#EA4335',
                bob: '#4285F4',
                ans: '#f5b700'
            };

            const icons = {
                alice: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="${colors.alice.replace('#', '%23')}" stroke="white" stroke-width="0.5"><path d="M12 5.5A3.5 3.5 0 0 1 15.5 9a3.5 3.5 0 0 1-3.5 3.5A3.5 3.5 0 0 1 8.5 9A3.5 3.5 0 0 1 12 5.5M5 21v-2a7 7 0 0 1 14 0v2z"/></svg>`,
                bob: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="${colors.bob.replace('#', '%23')}" stroke="white" stroke-width="0.5"><path d="M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z"/></svg>`
            };

            const nodes = new vis.DataSet([
                { id: 'ans', label: 'The Nexus (ANS)', color: { background: colors.ans, border: colors.ans }, shape: 'star', size: 40, x: 0, y: -100, fixed: true, font: { color: '#e0e0e0' } },
                { id: 'alice', label: 'Alice', shape: 'image', image: icons.alice, size: 40, x: -300, y: 100, fixed: true, font: { color: '#e0e0e0' } },
                { id: 'bob', label: 'Bob', shape: 'image', image: icons.bob, size: 40, x: 300, y: 100, fixed: true, font: { color: '#e0e0e0' } },
            ]);
            const edges = new vis.DataSet([]);
            const network = new vis.Network(container, { nodes, edges }, { physics: false, interaction: { dragNodes: false } });

            function animateEdge(from, to) {
                const edgeId = `edge-${from}-${to}-${Date.now()}`;
                edges.add({
                    id: edgeId,
                    from: from,
                    to: to,
                    arrows: 'to',
                    color: { color: colors[from], highlight: colors[from] },
                    width: 4
                });
                setTimeout(() => edges.remove(edgeId), 2000);
            }

            function animatePacket(from, to, content) {
                const fromNode = nodes.get(from);
                const toNode = nodes.get(to);
                const containerRect = container.getBoundingClientRect();

                const packet = document.createElement('div');
                packet.className = 'data-packet';
                packet.innerHTML = content;
                container.appendChild(packet);

                const startX = fromNode.x + containerRect.width / 2;
                const startY = fromNode.y + containerRect.height / 2;
                const endX = toNode.x + containerRect.width / 2;
                const endY = toNode.y + containerRect.height / 2;

                packet.style.left = `${startX}px`;
                packet.style.top = `${startY}px`;
                packet.style.opacity = 1;
                packet.style.transform = 'scale(1)';

                setTimeout(() => {
                    packet.style.left = `${endX}px`;
                    packet.style.top = `${endY}px`;
                }, 100);

                setTimeout(() => {
                    packet.style.opacity = 0;
                    packet.style.transform = 'scale(0.5)';
                    setTimeout(() => packet.remove(), 500);
                }, 1600);
            }

            const eventSource = new EventSource('/events');
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'narration') {
                    narratorText.textContent = data.message;
                } else if (data.type === 'data_transfer') {
                    animateEdge(data.from, data.to);
                    animatePacket(data.from, data.to, data.payload);
                } else if (data.type === 'verification_result') {
                    resultPanel.style.opacity = 1;
                    resultText.textContent = data.message;
                    resultText.className = data.status === 'SUCCESS' ? 'text-4xl font-bold text-green-400' : 'text-4xl font-bold text-red-400';
                }
            };
        });
    </script>
</body>
</html>
